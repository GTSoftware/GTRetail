<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core">

    <h:form id="editProductoForm">


        <h:panelGrid id="fechasGrid" columns="2" >
            <h:outputLabel value="#{msg.fechaAlta}:" />
            <h:outputLabel value="#{productoEditBean.productoActual.fechaAlta}">
                <f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
            </h:outputLabel>
            <h:outputLabel value="#{msg.fechaModificacion}:" />
            <h:outputLabel value="#{productoEditBean.productoActual.fechaUltimaModificacion}">
                <f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
            </h:outputLabel>
        </h:panelGrid>
        <p:tabView id="editProductoTabView" >

            <p:tab title="Datos básicos" >
                <h:panelGrid id="datosBasicosGrid" columns="3" >
                    <h:outputLabel for="idProductoField" value="#{msg.id}:"  />
                    <h:outputText id="idProductoField" value="#{productoEditBean.productoActual.id}"  />
                    <h:outputLabel/>

                    <h:outputLabel for="codigoProductoField" value="#{msg.codigo}:"  />
                    <p:inputText id="codigoProductoField" value="#{productoEditBean.productoActual.codigoPropio}"
                                 maxlength="100" required="true" requiredMessage="#{msg.ingresarValor}"
                                 label="#{msg.codigo}"/>
                    <p:message for="codigoProductoField"/>

                    <h:outputLabel for="descripcionField" value="#{msg.descripcion}:" />
                    <p:inputText id="descripcionField" value="#{productoEditBean.productoActual.descripcion}"
                                 maxlength="200"
                                 size="100"
                                 required="true" requiredMessage="#{msg.ingresarDescripcion}"
                                 converter="#{stringFormatConverter}"
                                 label="#{msg.descripcion}"/>
                    <p:message for="descripcionField"/>

                    <h:outputLabel for="observacionesField" value="#{msg.observaciones}:" />
                    <p:inputTextarea id="observacionesField" value="#{productoEditBean.productoActual.observaciones}"
                                     maxlength="2048"
                                     autoResize="true"
                                     label="#{msg.observaciones}"/>
                    <p:message for="observacionesField"/>

                    <h:outputLabel for="activoField" value="#{msg.activo}:" />
                    <p:selectBooleanCheckbox  id="activoField"  value="#{productoEditBean.productoActual.activo}"
                                              required="false"/>
                    <p:message for="activoField" />

                </h:panelGrid>
            </p:tab>

            <!--Clasificación-->
            <p:tab title="Clasificación" >
                <h:panelGrid id="clasificacionGrid" columns="3" >
                    <h:outputLabel for="tipoProveeduriaField" value="#{msg.tipoProveeduria}:"/>
                    <p:selectOneMenu id="tipoProveeduriaField" value="#{productoEditBean.productoActual.idTipoProveeduria}"
                                     required="true" requiredMessage="#{msg.seleccionarUno}"
                                     converter="#{productosTiposProveeduriaConverter}"
                                     >
                        <f:selectItem  noSelectionOption="true" itemLabel="#{msg.seleccionarUno}"  itemValue="#{null}"/>

                        <f:selectItems value="#{productoEditBean.listTipoProveeduria}" var="tipoProd" itemLabel="#{tipoProd.nombreTipoProveeduria}"
                                       itemValue="#{tipoProd}"/>

                    </p:selectOneMenu>
                    <p:message for="tipoProveeduriaField"/>




                    <h:outputLabel for="rubroField" value="#{msg.productoRubro}:" />
                    <h:panelGroup >
                        <p:selectOneMenu id="rubroField"  value="#{productoEditBean.productoActual.idRubro}"
                                         valueChangeListener="#{productoEditBean.cargarSubRubros}" converter="#{productosRubrosConverter}"
                                         label="#{msg.productoRubro}"
                                         >

                            <f:selectItem  noSelectionOption="true" itemLabel="#{msg.seleccionarUno}"  itemValue="#{null}"/>
                            <f:selectItems value="#{productoEditBean.listRubros}" var="rubro" itemLabel="#{rubro.nombreRubro}" itemValue="#{rubro}"/>
                            <p:ajax event="valueChange"
                                    update=":editProductoForm:editProductoTabView:subRubroPanelGroup"  process="@this"/>
                        </p:selectOneMenu>


<!--                        <p:commandButton icon="ui-icon-plus" action="#{productoEditBean.nuevoRubro}"
                                         immediate="true" update=":nuevoRubroForm"
                                         oncomplete="PF('dlg2').show();" />-->
                    </h:panelGroup>
                    <p:message for="rubroField"/>


                    <h:outputLabel for="subRubroField" value="#{msg.productoSubRubro}:" />
                    <h:panelGroup id="subRubroPanelGroup">

                        <p:selectOneMenu id="subRubroField" value="#{productoEditBean.productoActual.idSubRubro}"
                                         required="true" converter="#{productosSubRubrosConverter}"
                                         requiredMessage="#{msg.seleccionarUno}"
                                         label="#{msg.productoSubRubro}"
                                         >

                            <f:selectItem  noSelectionOption="true" itemLabel="#{msg.seleccionarUno}" itemValue="#{null}" />
                            <f:selectItems value="#{productoEditBean.listSubRubros}" var="subRubro"
                                           itemLabel="#{subRubro.nombreSubRubro}" itemValue="#{subRubro}"/>
                        </p:selectOneMenu>


<!--                        <p:commandButton id="btnNuevoSubRubro" icon="ui-icon-plus" action="#{productoEditBean.nuevoSubRubro}" immediate="true"
                                         oncomplete="PF('dlgSubRubro').show();" update=":nuevoSubRubroForm"
                                         rendered="#{productoEditBean.productoActual.idRubro ne null}"/>-->
                    </h:panelGroup>
                    <p:message for="subRubroField"/>


                    <h:outputLabel for="marcaField" value="#{msg.marca}:" />
                    <h:panelGroup >
                        <p:selectOneMenu id="marcaField" value="#{productoEditBean.productoActual.idMarca}"
                                         required="true" requiredMessage="#{msg.ingresarValor}"
                                         converter="#{productosMarcasConverter}"
                                         label="#{msg.marca}">
                            <f:selectItem noSelectionOption="true" itemLabel="#{msg.seleccionarUno}" itemValue="#{null}"/>
                            <f:selectItems value="#{productoEditBean.listMarcas}" var="marca" itemLabel="#{marca.nombreMarca}" itemValue="#{marca}"/>

                        </p:selectOneMenu>



<!--                        <p:commandButton id="btnNuevaMarca" icon="ui-icon-plus" action="#{productoEditBean.cargarNuevaMarca}" immediate="true"
                                         oncomplete="PF('dlgNuevaMarca').show();" update=":nuevaMarca"
                                         />-->
                    </h:panelGroup>
                    <p:message for="marcaField"/>



                    <h:outputLabel for="tipoUnidadCompraSelect" value="#{msg.productoTipoUnidadCompra}:"/>
                    <p:selectOneMenu id="tipoUnidadCompraSelect" value="#{productoEditBean.productoActual.idTipoUnidadCompra}"
                                     required="true" requiredMessage="#{msg.seleccionarValor}" converter="#{productosTiposUnidadesConverter}"
                                     label="#{msg.productoTipoUnidadCompra}">

                        <f:selectItem noSelectionOption="true" itemLabel="#{msg.seleccionarUno}" itemValue="#{null}"/>
                        <f:selectItems value="#{productoEditBean.listTipoUnidades}" var="tipoUnidad" itemLabel="#{tipoUnidad.nombreUnidad}"
                                       itemValue="#{tipoUnidad}"/>
                    </p:selectOneMenu>
                    <p:message for="tipoUnidadCompraSelect"/>

                    <h:outputLabel for="tipoUnidadVentaSelect" value="#{msg.productoTipoUnidadVenta}:"/>
                    <p:selectOneMenu id="tipoUnidadVentaSelect" value="#{productoEditBean.productoActual.idTipoUnidadVenta}"
                                     required="true" requiredMessage="#{msg.seleccionarValor}" converter="#{productosTiposUnidadesConverter}"
                                     label="#{msg.productoTipoUnidadVenta}">

                        <f:selectItem noSelectionOption="true" itemLabel="#{msg.seleccionarUno}" itemValue="#{null}"/>
                        <f:selectItems value="#{productoEditBean.listTipoUnidades}" var="tipoUnidad" itemLabel="#{tipoUnidad.nombreUnidad}"
                                       itemValue="#{tipoUnidad}"/>
                    </p:selectOneMenu>
                    <p:message for="tipoUnidadCompraSelect"/>

                    <h:outputLabel for="unidadCompraVentaField" value="#{msg.unidadCompraUnidadVenta}:"/>
                    <p:inputText id="unidadCompraVentaField" value="#{productoEditBean.productoActual.unidadesCompraUnidadesVenta}"
                                 title="1 Unidad de compra son X unidades de venta">
                        <f:validateDoubleRange minimum="0"
                                               maximum="9999999999999999999.99" />
                    </p:inputText>
                    <p:message for="unidadCompraVentaField"/>
                </h:panelGrid>
            </p:tab>

            <!--Precios-->
            <p:tab title="Precios">
                <p:fragment id="preciosFragment" autoUpdate="true"  >
                    <h:panelGrid id="precioGrid" columns="2" columnClasses="top-aligned-columns" >
                        <h:panelGroup id="pgCostos" >
                            <h:panelGrid  columns="3" columnClasses="top-aligned-columns" >
                                <h:outputLabel for="costoAdquisicionField" value="#{msg.costoAdquisicion}:" />
                                <p:inputText id="costoAdquisicionField" value="#{productoEditBean.productoActual.costoAdquisicionNeto}"
                                             required="true" requiredMessage="#{msg.ingresarValor}"
                                             style="text-align: right"
                                             label="#{msg.costoAdquisicion}">

                                    <p:ajax event="blur" listener="#{productoEditBean.actualizarPrecios()}"
                                            update=":editProductoForm:editProductoTabView:precioGrid"/>
                                    <f:validateDoubleRange minimum="-9999999999999999999.9999"
                                                           maximum="9999999999999999999.9999" />
                                </p:inputText>
                                <p:message for="costoAdquisicionField"/>


                                <h:outputLabel for="alicuotaIVAField" value="#{msg.alicuotaIVA}:"/>
                                <p:selectOneMenu id="alicuotaIVAField" value="#{productoEditBean.productoActual.idAlicuotaIva}" required="true"
                                                 requiredMessage="#{msg.seleccionarValor}" converter="#{fiscalAlicuotaIVAConverter}"
                                                 label="#{msg.alicuotaIVA}">
                                    <f:selectItem  noSelectionOption="true" itemLabel="#{msg.seleccionarUno}" itemValue="#{null}" />
                                    <f:selectItems value="#{productoEditBean.listAlicuotaIVA}" var="alicuota"
                                                   itemLabel="#{alicuota.nombreAlicuotaIva}" itemValue="#{alicuota}" />

                                    <p:ajax event="valueChange" listener="#{productoEditBean.actualizarPrecios()}"
                                            update="preciosFragment"
                                            process="@this"/>

                                </p:selectOneMenu>
                                <p:message for="alicuotaIVAField"/>

                                <h:outputLabel for="costoFinalField" value="#{msg.costoFinal}:" />
                                <p:inputText id="costoFinalField" value="#{productoEditBean.productoActual.costoFinal}"
                                             readonly="true"
                                             style="text-align: right"
                                             label="#{msg.costoFinal}">
                                    <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="number"/>
                                </p:inputText>
                                <p:message for="costoFinalField"/>
                            </h:panelGrid>

                        </h:panelGroup>
                        <h:panelGroup id="pgPrecios" >
                            <p:remoteCommand name="onCellEdit" update="@this " />


                            <h:panelGrid  columns="2" >

                                <h:outputLabel for="porcentajesTable" value="#{msg.porcentajes}:"/>



                                <h:selectOneMenu id="porcentajeSelect" value="#{productoEditBean.tipoPorcentajeSeleccionado}"
                                                 converter="#{productosTiposPorcentajesConverter}"
                                                 style="width:100%">

                                    <f:selectItems value="#{productoEditBean.tiposPorcentajesList}"
                                                   var="lista" itemLabel="#{lista.nombreTipo}"
                                                   itemValue="#{lista}" />
                                </h:selectOneMenu>

                                <h:outputLabel />

                                <p:commandButton id="addPorcentajeButton"
                                                 icon="ui-icon-plus"
                                                 action="#{productoEditBean.addPorcentaje()}"
                                                 update="@this"
                                                 ajax="true"
                                                 />

                                <h:outputLabel />

                                <p:dataTable id="porcentajesTable"
                                             var="porcentaje"
                                             value="#{productoEditBean.productoActual.porcentajes}"
                                             sortMode="single"
                                             emptyMessage="#{msg.busquedaSinResultados}"
                                             rowKey="#{porcentaje.id}"
                                             style="width: 100%"
                                             resizableColumns="true"
                                             scrollable="true"
                                             editable="true"
                                             editMode="cell"> 

                                    <p:ajax event="cellEdit"
                                            listener="#{productoEditBean.actualizarPrecios()}"
                                            oncomplete="onCellEdit()"
                                            />

                                    <p:column  >
                                        <f:facet name="header">
                                            Nombre
                                        </f:facet>
                                        <p:cellEditor>
                                            <f:facet name="output">
                                                <h:outputText value="#{porcentaje.idTipoPorcentaje.nombreTipo}" />
                                            </f:facet>
                                            <f:facet name="input">
                                                <h:selectOneMenu value="#{porcentaje.idTipoPorcentaje}"
                                                                 converter="#{productosTiposPorcentajesConverter}"
                                                                 style="width:100%">

                                                    <f:selectItems value="#{productoEditBean.tiposPorcentajesList}"
                                                                   var="tipoPorcentaje" itemLabel="#{tipoPorcentaje.nombreTipo}"
                                                                   itemValue="#{tipoPorcentaje}" />
                                                </h:selectOneMenu>
                                            </f:facet>
                                        </p:cellEditor>
                                    </p:column>
                                    <p:column  >
                                        <f:facet name="header">
                                            Porcentaje
                                        </f:facet>
                                        <p:cellEditor>
                                            <f:facet name="output">
                                                <h:outputText value="#{porcentaje.valor}" /></f:facet>
                                            <f:facet name="input">
                                                <p:inputText id="porcentajeValorField" value="#{porcentaje.valor}" style="width:96%"/>
                                            </f:facet>
                                        </p:cellEditor>

                                    </p:column>

                                    <p:column >
                                        <f:facet name="header">
                                            #{msg.fechaModificacion}
                                        </f:facet>
                                        <h:outputLabel value="#{porcentaje.fechaModificacion}">
                                            <f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column  exportable="false" style="width: 50px">
                                        <f:facet name="header">
                                            #{msg.borrar}
                                        </f:facet>
                                        <p:commandButton id="borrarPorcentajeButton"
                                                         icon="ui-icon-trash"
                                                         process="@this"
                                                         action="#{productoEditBean.removePorcentaje(porcentaje)}">
                                        </p:commandButton>
                                    </p:column>

                                </p:dataTable>



                                <h:outputLabel for="preciosTable" value="#{msg.precioVenta}:"/>


                                <h:selectOneMenu id="listaPreciosSelect" value="#{productoEditBean.listaSeleccionada}"
                                                 converter="#{productosListasPreciosConverter}"
                                                 style="width:100%">

                                    <f:selectItems value="#{productoEditBean.listasPrecios}"
                                                   var="lista" itemLabel="#{lista.nombreLista}"
                                                   itemValue="#{lista}" />
                                </h:selectOneMenu>

                                <h:outputLabel />

                                <p:commandButton id="addPrecioButton"
                                                 icon="ui-icon-plus"
                                                 action="#{productoEditBean.addLista()}"
                                                 update=":editProductoForm:editProductoTabView:pgPrecios"
                                                 ajax="true"
                                                 process="listaPreciosSelect"
                                                 />
                                <h:outputLabel />

                                <p:dataTable id="preciosTable" value="#{productoEditBean.productoActual.precios}"
                                             var="precio"
                                             sortMode="single"
                                             emptyMessage="#{msg.campoRequerido}"
                                             rowKey="#{precio.idPrecio}"
                                             style="width: 100%"
                                             resizableColumns="true"
                                             scrollable="true"
                                             editable="true"
                                             editMode="cell"> 

                                    <p:ajax event="cellEdit" listener="#{productoEditBean.actualizarPrecios()}"
                                            oncomplete="onCellEdit()" />

                                    <p:column  >
                                        <f:facet name="header">
                                            #{msg.listaPrecio}
                                        </f:facet>
                                        <h:outputLabel value="#{precio.idListaPrecios.nombreLista}"/>
                                    </p:column>
                                    <p:column  >
                                        <f:facet name="header">
                                            #{msg.utilidad} %
                                        </f:facet>
                                        <p:cellEditor>
                                            <f:facet name="output">
                                                <h:outputText value="#{precio.utilidad}" /></f:facet>
                                            <f:facet name="input">
                                                <p:inputText id="utilidadField" value="#{precio.utilidad}" style="width:96%"/></f:facet>
                                        </p:cellEditor>

                                    </p:column>
                                    <p:column  >
                                        <f:facet name="header">
                                            #{msg.neto}
                                        </f:facet>
                                        <h:outputLabel value="#{precio.neto}"  >
                                            <f:convertNumber type="currency" groupingUsed="true"
                                                             currencySymbol="$ "/>
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column  >
                                        <f:facet name="header">
                                            #{msg.precio}
                                        </f:facet>
                                        <h:outputLabel value="#{precio.precio}"  style="font-size: medium; font-weight: bold">
                                            <f:convertNumber type="currency" groupingUsed="true"
                                                             currencySymbol="$ "/>
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            #{msg.fechaModificacion}
                                        </f:facet>
                                        <h:outputLabel value="#{precio.fechaModificacion}">
                                            <f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column  exportable="false" style="width: 50px">
                                        <f:facet name="header">
                                            #{msg.borrar}
                                        </f:facet>
                                        <p:commandButton id="borrarPrecioButton"
                                                         icon="ui-icon-trash"
                                                         process="@this"
                                                         action="#{productoEditBean.removePrecio(precio)}"
                                                         >
                                        </p:commandButton>
                                    </p:column>

                                </p:dataTable>


                            </h:panelGrid>

                        </h:panelGroup>

                    </h:panelGrid>
                </p:fragment>
            </p:tab>

            <!--Proveedor-->
            <p:tab title="Proveedor">
                <h:panelGrid id="proveedorGrid" columns="3" >


                    <h:outputLabel for="proveedorHabitualField" value="#{msg.proveedor}:"/>
                    <p:selectOneMenu id="proveedorHabitualField" value="#{productoEditBean.productoActual.idProveedorHabitual}"
                                     converter="#{personasConverter}"
                                     required="false" requiredMessage="#{msg.seleccionarUno}">
                        <f:selectItem  noSelectionOption="true" itemLabel="#{msg.seleccionarUno}"  itemValue="#{null}"/>
                        <f:selectItems value="#{productoEditBean.listProveedores}" var="proveedor"
                                       itemLabel="#{proveedor.nombreFantasia}"
                                       itemValue="#{proveedor}"/>

                    </p:selectOneMenu>
                    <p:message for="proveedorHabitualField"/>

                </h:panelGrid>
            </p:tab>
            <p:tab title="Existencias">

            </p:tab>
        </p:tabView>

        <h:panelGrid columns="2" >
            <p:commandButton id="guardarButton"
                             value="#{msg.guardar}"
                             icon="ui-icon-disk"
                             action="#{productoEditBean.doGuardar}"
                             update="@form"
                             ajax="true"
                             />

            <p:commandButton id="cancelarButton"
                             value="#{msg.cancelar}"
                             icon="ui-icon-cancel"
                             action="/protected/productos/consultarProductos.xhtml?faces-redirect=true"
                             immediate="true"
                             ajax="false" />
        </h:panelGrid>


    </h:form>

    <h:form id="nuevoRubroForm">
        <p:dialog modal="true" header="#{msg.nuevoRubro}" widgetVar="dlg2"  height="100">


            <h:panelGrid columns="3">


                <h:outputLabel for="descripcionRubroField" value="#{msg.productoRubro}:" />
                <p:inputText id="descripcionRubroField" value="#{productoEditBean.productosRubrosNuevo.nombreRubro}"
                             required="true" requiredMessage="#{msg.ingresarValor}"/>
                <p:message for="descripcionRubroField"/>
            </h:panelGrid>
            <h:panelGrid columns="2">
                <p:commandButton  value="#{msg.guardar}"  action="#{productoEditBean.doGuardarRubro}"
                                  update=":editProductoForm:editProductoTabView:rubroField" onclick="PF('dlg2').hide();" />



            </h:panelGrid>
        </p:dialog>
    </h:form>


    <h:form id="nuevoSubRubroForm">
        <p:dialog modal="true" header="#{msg.nuevoSubRubro}" widgetVar="dlgSubRubro"  height="100">

            <h:panelGrid columns="2">

                <h:outputLabel for="descripcionRubro" value="#{msg.productoRubro}:" />
                <h:outputText  id="descripcionRubro" value="#{productoEditBean.productosSubRubrosNuevo.idRubro.nombreRubro}"
                               />
            </h:panelGrid>

            <h:panelGrid columns="3" >

                <h:outputLabel for="descripcionSubRubroField" value="#{msg.productoSubRubro}:" />
                <p:inputText id="descripcionSubRubroField" value="#{productoEditBean.productosSubRubrosNuevo.nombreSubRubro}"
                             required="true" requiredMessage="#{msg.ingresarValor}"
                             converter="#{stringFormatConverter}"/>
                <p:message for="descripcionSubRubroField"/>
            </h:panelGrid>
            <h:panelGrid columns="2">
                <p:commandButton  value="#{msg.guardar}"  action="#{productoEditBean.doGuardarSubRubro}"
                                  update=":editProductoForm:editProductoTabView:subRubroField" onclick="PF('dlgSubRubro').hide();"/>

            </h:panelGrid>
        </p:dialog>
    </h:form>

    <h:form id="nuevaMarca">
        <p:dialog modal="true" header="#{msg.nuevaMarca}" widgetVar="dlgNuevaMarca"  height="100">



            <h:panelGrid columns="3" >

                <h:outputLabel for="nombreMarcaField" value="#{msg.marca}:" />
                <p:inputText id="nombreMarcaField" value="#{productoEditBean.nuevaMarca.nombreMarca}"
                             required="true" requiredMessage="#{msg.ingresarValor}"
                             converter="#{stringFormatConverter}"/>
                <p:message for="nombreMarcaField"/>
            </h:panelGrid>
            <h:panelGrid columns="2">
                <p:commandButton  value="#{msg.guardar}"  action="#{productoEditBean.doGuardarMarca}"
                                  update=":editProductoForm:editProductoTabView:marcaField" onclick="PF('dlgNuevaMarca').hide();"/>

            </h:panelGrid>
        </p:dialog>
    </h:form>


</html>
