<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:gtsoftware="http://xmlns.jcp.org/jsf/composite/gtsoftware">



    <h:form id="formContenido" >
        <p:panel id="listadoPanel" header="#{msg.ventasListado}">
            <p:tabView id="busquedaTab">
                <p:defaultCommand target="buscarButton"/>

                <p:tab title="#{msg.busquedaBasica}">
                    <h:panelGrid columns="2">
                        <p:outputLabel value="#{msg.fechaDesde}:" for="fechaDesdeField"/>
                        <p:calendar id="fechaDesdeField" value="#{searchVentasBean.filter.fechaVentaDesde}"
                                    pattern="dd/MM/yyyy hh:mm:ss a" showButtonPanel="true" />

                        <p:outputLabel value="#{msg.fechaHasta}:" for="fechaHastaField"/>
                        <p:calendar id="fechaHastaField" value="#{searchVentasBean.filter.fechaVentaHasta}"
                                    pattern="dd/MM/yyyy hh:mm:ss a" showButtonPanel="true" />

                        <p:outputLabel value="#{msg.cliente}:" for="razonSocialField"/>
                        <h:panelGroup >
                            <p:autoComplete id="razonSocialField"
                                            value="#{searchVentasBean.filter.idPersona}"
                                            completeMethod="#{searchVentasBean.findClientesByString}"
                                            var="cli" itemLabel="#{cli.razonSocial}"
                                            itemValue="#{cli}"
                                            converter="#{personasConverter}"
                                            forceSelection="true"
                                            minQueryLength="3"
                                            >

                            </p:autoComplete>
                            <p:commandButton id="buscarClienteButton" icon="ui-icon-search"
                                             update=":busquedaPersonasDialogForm:busquedaPersonasDialog"
                                             oncomplete="PF('clientesDialog').show()"
                                             process="@this" />
                        </h:panelGroup>


                        <h:outputLabel for="nroFacturaField" value="#{msg.factura}:" />
                        <p:inputText  id="nroFacturaField"  value="#{searchVentasBean.filter.numeroFactura}"
                                      converter="#{stringFormatConverter}"/>

                        <h:outputLabel for="anuladasField" value="#{msg.anulada}s" />
                        <p:selectBooleanCheckbox  id="anuladasField"  value="#{searchVentasBean.filter.anulada}"/>

                    </h:panelGrid>
                    <p:commandButton id="buscarButton" action="#{searchVentasBean.search()}"
                                     value="#{msg.buscar}"
                                     update="@form"
                                     icon="ui-icon-search"
                                     />
                </p:tab>

                <p:tab title="#{msg.busquedaAvanzada}" >
                    #{msg.noImplementado}
                </p:tab>
            </p:tabView>

            <h:panelGrid>

                <p:dataTable id="ventasTable" value="#{searchVentasBean.dataModel}" var="venta"
                             rows="15"
                             lazy="true"
                             paginator="true"
                             emptyMessage="#{msg.busquedaSinResultados}"
                             rowKey="#{venta.id}"
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown} {Exporters}"
                             rowsPerPageTemplate="10,15,30"
                             style="width: 100%"
                             resizableColumns="true"
                             scrollable="true"
                             >
                    <f:facet name="{Exporters}">
                        <h:commandLink>

                            <p:graphicImage library="images" name="excel.png" width="24"/>
                            <p:dataExporter type="xls" target="ventasTable" fileName="ventas" />
                        </h:commandLink>

                        <h:commandLink>
                            <p:graphicImage library="images" name="pdf.png" width="24"/>
                            <p:dataExporter type="pdf" target="ventasTable" fileName="ventas"/>
                        </h:commandLink>

                        <h:commandLink>
                            <p:graphicImage library="images" name="csv.png" width="24"/>
                            <p:dataExporter type="csv" target="ventasTable" fileName="ventas" />
                        </h:commandLink>

                        <h:commandLink>
                            <p:graphicImage library="images" name="xml.png" width="24"/>
                            <p:dataExporter type="xml" target="ventasTable" fileName="ventas" />
                        </h:commandLink>
                    </f:facet>
                    <p:column style="width:16px" exportable="false">
                        <p:rowToggler />
                    </p:column>
                    <p:column  sortBy="#{venta.id}" style="width: 2%">
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.tablaId}" />
                        </f:facet>
                        <h:outputLabel value="#{venta.id}"/>
                    </p:column>

                    <p:column  sortBy="#{venta.idSucursal.nombreSucursal}" >
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.sucursal}"/>
                        </f:facet>
                        <h:outputLabel value="#{venta.idSucursal.nombreSucursal}"/>
                    </p:column>

                    <p:column sortBy="#{venta.fechaVenta}" >
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.fecha}"/>
                        </f:facet>
                        <h:outputLabel value="#{venta.fechaVenta}">
                            <f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
                        </h:outputLabel>
                    </p:column>

                    <p:column sortBy="#{venta.idPersona.razonSocial}">
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.tablaRazonSocial}"/>
                        </f:facet>
                        <h:outputLabel value="#{venta.idPersona.razonSocial}"/>
                    </p:column>

                    <p:column sortBy="#{venta.idCondicionVenta.nombreCondicion}">
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.condicionVenta}"/>
                        </f:facet>
                        <h:outputLabel value="#{venta.idCondicionVenta.nombreCondicion}"/>
                    </p:column>

                    <p:column sortBy="#{venta.total}">
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.total}"/>
                        </f:facet>
                        <h:outputLabel value="#{venta.total}">
                            <f:convertNumber groupingUsed="true" type="currency" />
                        </h:outputLabel>
                    </p:column>
                    <p:column sortBy="#{venta.saldo}">
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.saldo}"/>
                        </f:facet>
                        <h:outputLabel value="#{venta.saldo}">
                            <f:convertNumber groupingUsed="true" type="currency" />
                        </h:outputLabel>
                    </p:column>
                    <p:column sortBy="#{venta.idRegistroIva}">
                        <f:facet name="header">
                            <h:outputLabel value="#{msg.factura}"/>
                        </f:facet>
                        <h:outputLabel rendered="#{not empty venta.idRegistroIva and not venta.anulada}"
                                       value="#{venta.idRegistroIva.letraFactura} #{venta.idRegistroIva.puntoVentaFactura}-#{venta.idRegistroIva.numeroFactura}" />

                        <h:outputLabel rendered="#{empty venta.idRegistroIva and not venta.anulada}"
                                       value="#{msg.no}" />
                        <h:outputLabel rendered="#{venta.anulada}"
                                       value="#{msg.anulada}" />
                    </p:column>



                    <p:column style="width: 32px" exportable="false" >
                        <f:facet name="header">
                            #{msg.ver}
                        </f:facet>
                        <p:commandButton icon="ui-icon-search" action="vista/verVenta"  ajax="false" >
                            <f:param name="idVenta" value="#{venta.id}"/>
                        </p:commandButton>

                    </p:column>

                    <p:rowExpansion>
                        <p:dataTable id="productosTable" value="#{venta.ventasLineasList}" var="lineaVenta"

                                     emptyMessage="#{msg.productosNoCargados}"
                                     resizableColumns="true">

                            <p:column style="text-align: right; width: 5%">
                                <f:facet name="header">
                                    #{msg.tablaId}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.id}" />
                            </p:column>
                            <p:column style="text-align: left; width: 5%">
                                <f:facet name="header">
                                    #{msg.codigo}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.codigoPropio}" />
                            </p:column>
                            <p:column style="text-align: left; width: 40%">
                                <f:facet name="header">
                                    #{msg.tablaDescripcion}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.descripcion}" />
                            </p:column>
                            <p:column style="text-align: right; width: 5%">
                                <f:facet name="header">
                                    #{msg.tablaCantidad}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.cantidad}" />
                            </p:column>
                            <p:column style="text-align: left; width: 5%">
                                <f:facet name="header">
                                    #{msg.tablaUnidad}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.idTipoUnidadVenta.nombreUnidad}" />
                            </p:column>
                            <p:column style="text-align: right; width: 2%">
                                <f:facet name="header">
                                    #{msg.tablaIVA}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.idAlicuotaIva.valorAlicuota}" >
                                    <f:convertNumber  type="number" groupingUsed="true"/>
                                </h:outputText>
                            </p:column>

                            <p:column style="text-align: right; width: 10%">
                                <f:facet name="header">
                                    #{msg.tablaPrecioUnitario}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.precioVentaUnitario}" >
                                    <f:convertNumber currencySymbol="$" type="currency" groupingUsed="true"/>
                                </h:outputText>
                            </p:column>

                            <p:column style="text-align: right; width: 10%">
                                <f:facet name="header">
                                    #{msg.tablaSubTotal}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.subTotal}" >
                                    <f:convertNumber currencySymbol="$" type="currency"  groupingUsed="true"/>
                                </h:outputText>
                            </p:column>



                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column colspan="7" footerText="#{msg.total}"
                                              style="text-align:right; font-size: larger"  />

                                    <p:column footerText="\$#{venta.total}" style=" font-size: xx-large" />
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>
                    </p:rowExpansion>

                </p:dataTable>


            </h:panelGrid>
            <p:panel id="totalesVentasPanel" header="#{msg.totales}" >

                <h:panelGrid columns="2" >
                    <p:outputLabel value="#{msg.totalVentas}:" />
                    <p:outputLabel value="#{searchVentasBean.totalVentas}" style="font-size: x-large; font-weight: bold" >
                        <f:convertNumber groupingUsed="true" type="currency" />
                    </p:outputLabel>

                    <p:outputLabel value="#{msg.totalVentasSF}:" />
                    <p:outputLabel value="#{searchVentasBean.totalVentasSinFacturar}" style="font-size: x-large; font-weight: bold" >
                        <f:convertNumber groupingUsed="true" type="currency" />
                    </p:outputLabel>

                    <p:outputLabel value="#{msg.totalVentasF}:" />
                    <p:outputLabel value="#{searchVentasBean.totalVentasFacturadas}" style="font-size: x-large; font-weight: bold" >
                        <f:convertNumber groupingUsed="true" type="currency" />
                    </p:outputLabel>
                </h:panelGrid>
            </p:panel>
        </p:panel>
    </h:form>
    <h:form id="busquedaPersonasDialogForm">

        <p:dialog id='busquedaPersonasDialog'
                  header="#{msg.busquedaClientes}"
                  widgetVar="clientesDialog"
                  resizable="true"
                  closeOnEscape="true"
                  showEffect="fade" hideEffect="clip" modal="true"
                  dynamic="true">

            <gtsoftware:busquedaPersonas personaSeleccionada="#{searchVentasBean.filter.idPersona}"
                                         textoBusqueda="#{clientesSearchBean.filter.txt}"
                                         busquedaAction="#{clientesSearchBean.doSearch()}"
                                         personasList="#{clientesSearchBean.dataModel}"
                                         >
            </gtsoftware:busquedaPersonas>
            <p:commandButton value="#{msg.ok}" icon="ui-icon-check"
                             oncomplete="PF('clientesDialog').hide()"
                             process="@this"
                             update=":formContenido:busquedaTab"/>


        </p:dialog>


    </h:form>

</html>