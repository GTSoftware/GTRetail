<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:gtsoftware="http://xmlns.jcp.org/jsf/composite/gtsoftware">



    <h:panelGroup  id="insertarPanel" >
        <p:focus transient="true" context="insertarPanel" for="cantidadField" />
        <p:defaultCommand target="insertarButton" />

        <p:panelGrid layout="grid"  styleClass="ui-panelgrid-blank"  columns="10">

            <p:outputLabel value="#{msg.buscar}:" for="buscarProductosButton"/>
            <p:outputLabel value="#{msg.listaPrecio}:" for="listaField"/>
            <p:outputLabel value="#{msg.idProducto}:" for="idProductoField"/>
            <p:outputLabel value="#{msg.codigo}:" for="codigoProductoField"/>
            <p:outputLabel value="#{msg.descripcion}:" for="descripcionField"/>
            <p:outputLabel value="#{msg.cantidad}:" for="cantidadField"/>
            <p:outputLabel value="#{msg.unidadVenta}:" for="unidadVentaField"/>
            <p:outputLabel value="#{msg.precioUnitario}:" for="precioVentaField"/>
            <p:outputLabel value="#{msg.subTotal}:" for="subTotalField"/>
            <p:outputLabel value="#{msg.insertar}" for="insertarButton" />

            <p:commandButton id="buscarProductosButton" icon="fa fa-fw fa-search"

                             oncomplete="PF('productosDialog').show()"
                             process="@none" />

            <p:selectOneMenu id="listaField" value="#{nuevaVentaBean.listaSeleccionada}"
                             required="true" requiredMessage="#{msg.seleccionarUno}"
                             converter="omnifaces.SelectItemsIndexConverter"
                             >

                <f:selectItems value="#{productosSearchBean.listasPrecio}" var="lista" itemLabel="#{lista.nombreLista}"
                               itemValue="#{lista}"/>

            </p:selectOneMenu>

            <p:inputText id="idProductoField"
                         value="#{nuevaVentaBean.productoSearchFilter.idProducto}"
                         required="false" >
                <f:convertNumber integerOnly="true" />
                <p:ajax  update="insertarPanel"
                         listener="#{nuevaVentaBean.buscarProductoPorClave()}" />

            </p:inputText>

            <p:inputText id="codigoProductoField"
                         value="#{nuevaVentaBean.productoSearchFilter.codigoPropio}"
                         required="false"
                         maxlength="100">
                <p:ajax update="insertarPanel"
                        listener="#{nuevaVentaBean.buscarProductoPorClave()}" />
            </p:inputText>


            <p:inputTextarea id="descripcionField"
                             value="#{nuevaVentaBean.lineaActual.descripcion}" readonly="true" />

            <p:inputText id="cantidadField"
                         value="#{nuevaVentaBean.lineaActual.cantidad}"
                         style="text-align: right" >

                <f:validateDoubleRange minimum="-9999999999999999999.99"
                                       maximum="9999999999999999999.99" />
                <p:ajax update="insertarPanel"
                        listener="#{nuevaVentaBean.calculatSubTotal()}" />
            </p:inputText>

            <h:outputText id="unidadVentaField"
                          value="#{nuevaVentaBean.lineaActual.idProducto.idTipoUnidadVenta.nombreUnidad}"/>

            <p:inputText id="precioVentaField"
                         value="#{empty nuevaVentaBean.lineaActual.idProducto ? 0 : nuevaVentaBean.lineaActual.precioVentaUnitario}"
                         readonly="#{empty nuevaVentaBean.lineaActual.idProducto.idTipoProveeduria.cambiarPrecioVenta ? true : !nuevaVentaBean.lineaActual.idProducto.idTipoProveeduria.cambiarPrecioVenta}" required="true" style="text-align: right">
                <p:ajax update="insertarPanel"
                        listener="#{nuevaVentaBean.calculatSubTotal()}" />
                <f:validateDoubleRange minimum="-9999999999999999999.9999"
                                       maximum="9999999999999999999.9999" />
            </p:inputText>

            <h:outputText id="subTotalField"
                          value="#{empty nuevaVentaBean.lineaActual ? 0 : nuevaVentaBean.lineaActual.subTotal}"
                          style="text-align: right">
                <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true" />
            </h:outputText>

            <p:commandButton id="insertarButton" icon="ui-icon-circle-arrow-s"
                             update="insertarPanel, datosPanel"
                             process="insertarPanel"
                             action="#{nuevaVentaBean.agregarLineaVenta()}" />

            <p:message for="idProductoField" />
            <p:message for="cantidadField" />
            <p:message for="precioVentaField" />
        </p:panelGrid >
    </h:panelGroup>

    <p:separator />

    <p:panel id="datosPanel" header="#{msg.productos}">
        <p:fragment autoUpdate="true">
            <p:dataTable id="productosTable" value="#{nuevaVentaBean.ventaActual.ventasLineasList}" var="lineaVenta"
                         rows="15"
                         paginator="true"
                         sortMode="multiple"
                         emptyMessage="#{msg.productosNoCargados}"
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                         rowsPerPageTemplate="10,15,30"
                         resizableColumns="true"
                         reflow="true">

                <p:column style="text-align: right; width: 5%">
                    <f:facet name="header">
                        #{msg.tablaId}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.idProducto.id}" />
                </p:column>
                <p:column style="text-align: left; width: 5%">
                    <f:facet name="header">
                        #{msg.codigo}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.idProducto.codigoPropio}" />
                </p:column>
                <p:column style="text-align: left; width: 40%">
                    <f:facet name="header">
                        #{msg.tablaDescripcion}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.descripcion}" />
                </p:column>
                <p:column style="text-align: right; width: 5%">
                    <f:facet name="header">
                        #{msg.tablaCantidad}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.cantidad}" />
                </p:column>
                <p:column style="text-align: left; width: 5%">
                    <f:facet name="header">
                        #{msg.tablaUnidad}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.idProducto.idTipoUnidadVenta.nombreUnidad}" />
                </p:column>
                <p:column style="text-align: right; width: 2%">
                    <f:facet name="header">
                        #{msg.tablaIVA}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.idProducto.idAlicuotaIva.valorAlicuota}" >
                        <f:convertNumber  type="number" groupingUsed="true"/>
                    </h:outputText>
                </p:column>

                <p:column style="text-align: right; width: 10%">
                    <f:facet name="header">
                        #{msg.tablaPrecioUnitario}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.idProducto.precioVenta}" >
                        <f:convertNumber currencySymbol="$" type="currency" groupingUsed="true"/>
                    </h:outputText>
                </p:column>

                <p:column style="text-align: right; width: 10%">
                    <f:facet name="header">
                        #{msg.tablaSubTotal}
                    </f:facet>
                    <h:outputText value="#{lineaVenta.subTotal}" >
                        <f:convertNumber currencySymbol="$" type="currency"  groupingUsed="true"/>
                    </h:outputText>
                </p:column>

                <p:column  exportable="false" style="width: 50px">
                    <f:facet name="header">
                        #{msg.borrar}
                    </f:facet>
                    <p:commandButton id="borrarItemButton"
                                     icon="ui-icon-trash"
                                     process="@this"
                                     action="#{nuevaVentaBean.eliminarLinea(lineaVenta)}">

                    </p:commandButton>
                </p:column>

                <p:columnGroup type="footer">
                    <p:row>
                        <p:column colspan="7" footerText="#{msg.total}"
                                  style="text-align:right; font-size: larger"  />

                        <p:column footerText="\$#{nuevaVentaBean.ventaActual.total}" style=" font-size: xx-large" />
                    </p:row>
                </p:columnGroup>

            </p:dataTable>

            <p:separator/>

            <p:dataTable id="ivaTable" value="#{nuevaVentaBean.importesIVA}" var="impIva"
                         style="width: 25%"
                         resizableColumns="true">
                <f:facet name="header" >
                    #{msg.tablaIVA}
                </f:facet>
                <p:column style="text-align: left">
                    <f:facet name="header">
                        #{msg.tablaAlicuota}
                    </f:facet>
                    <h:outputText value="#{impIva.alicuota.nombreAlicuotaIva}" />
                </p:column>
                <p:column style="text-align: right">
                    <f:facet name="header">
                        #{msg.tablaImporte}
                    </f:facet>
                    <h:outputText value="#{impIva.importeIva}" >
                        <f:convertNumber currencySymbol="$" type="currency"  groupingUsed="true"/>
                    </h:outputText>
                </p:column>
            </p:dataTable>
            <p:panelGrid layout="grid"  styleClass="ui-panelgrid-blank" columns="3" >
                <p:outputLabel value="#{msg.descuentoRecargo}:" />
                <p:inputText id="descuentoRecargoField"
                             value="#{nuevaVentaBean.descuentoRecargoGlobal}"
                             required="false" >
                    <f:validateDoubleRange minimum="-9999999999999999999.99"
                                           maximum="9999999999999999999.99" />
                </p:inputText>
                <p:commandButton id="cargarDescuentoRecargoButton" icon="ui-icon-circle-plus"
                                 action="#{nuevaVentaBean.doCargarDescuentoRecargoGlobal()}"
                                 process="descuentoRecargoField" />
            </p:panelGrid >
        </p:fragment>
    </p:panel>

    <ui:include src="buscarProdDlg.xhtml" />



</html>
