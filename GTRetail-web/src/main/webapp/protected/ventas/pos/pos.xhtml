<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:gtsoftware="http://java.sun.com/jsf/composite/gtsoftware">


    <!--Evento disparado para iniciar la conversación con el carrito-->
    <f:event listener="#{shopCartBean.initConversation}"
             type="preRenderView">
    </f:event>

    <div class="Container100 ui-fluid">
        <div class="Card">
            <h1 class="CardBigTopic TexAlCenter">POS</h1>
            <div class="SeparatorFull"/>
            <h:form id="formContenido" >

                <!--                <h:outputText id="cid"
                                              value="#{javax.enterprise.context.conversation.id}" />-->



                <p:focus for="idField"  />
                <p:panelGrid
                    layout="grid"  styleClass="ui-panelgrid-blank" columns="3" >


                    <p:inputText id="idField"

                                 value="#{shopCartBean.productosFilter.idProducto}"
                                 placeholder="Id">

                    </p:inputText>

                    <p:inputText id="codigoField"

                                 value="#{shopCartBean.productosFilter.codigoPropio}"
                                 placeholder="Código">

                    </p:inputText>



                    <p:inputText id="cantidadField"
                                 required="true"
                                 value="#{shopCartBean.cantidad}"
                                 placeholder="Cantidad">
                        <f:validateDoubleRange minimum="0.01"
                                               maximum="9999999999999999999.99" />

                    </p:inputText>


                </p:panelGrid>

                <div class="Container25 ui-fluid">
                    <p:commandButton id="insertarButton" icon="fa fa-fw fa-plus"
                                     title="#{msg.insertar}"
                                     action="#{shopCartBean.addToCart()}"
                                     update="@form"
                                     global="false"
                                     styleClass="GreenButton"/>

                    <p:commandButton id="buscarButton" icon="fa fa-fw fa-search"
                                     title="#{msg.buscar} productos"
                                     oncomplete="PF('dlgBusProd').show()"
                                     process="@none"
                                     global="false"/>
                </div>



                <p:remoteCommand name="onCellEdit" update="productosTable" immediate="true" />
                <div class="Container100 ui-fluid">
                    <div class="Card">
                        <div class="SeparatorFull"/>
                        <p:dataTable id="productosTable"  var="lineaVenta" value="#{shopCartBean.venta.comprobantesLineasList}"

                                     paginator="false"
                                     sortMode="single"
                                     emptyMessage="#{msg.productosNoCargados}"
                                     editable="true"
                                     editMode="cell"
                                     reflow="true"

                                     liveResize="true">

                            <p:ajax event="cellEdit"
                                    listener="#{shopCartBean.calcularTotal()}"
                                    oncomplete="onCellEdit()"
                                    global="false"
                                    />

                            <p:column style="text-align: right; ">
                                <f:facet name="header">
                                    #{msg.tablaId}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.id}" />
                            </p:column>
                            <p:column style="text-align: left; ">
                                <f:facet name="header">
                                    #{msg.codigo}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.codigoPropio}" />
                            </p:column>
                            <p:column style="text-align: left; ">
                                <f:facet name="header">
                                    #{msg.tablaDescripcion}
                                </f:facet>
                                <h:outputText id="decripcionProd" value="#{lineaVenta.descripcion}" />
                                <p:tooltip id="toolTipFade" for="decripcionProd"  value="#{lineaVenta.idProducto.observaciones}" />
                            </p:column>
                            <p:column style="text-align: right;">
                                <f:facet name="header">
                                    #{msg.tablaCantidad}
                                </f:facet>
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="#{lineaVenta.cantidad}" />
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText id="cantidadProdTabField" value="#{lineaVenta.cantidad}" >
                                            <f:validateDoubleRange minimum="0.01"
                                                                   maximum="9999999999999999999.99" />
                                        </p:inputText>
                                    </f:facet>
                                </p:cellEditor>

                            </p:column>
                            <p:column style="text-align: left; ">
                                <f:facet name="header">
                                    #{msg.tablaUnidad}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.idTipoUnidadVenta.nombreUnidad}" />
                            </p:column>
                            <p:column style="text-align: right; ">
                                <f:facet name="header">
                                    #{msg.tablaIVA}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.idProducto.idAlicuotaIva.valorAlicuota}" >
                                    <f:convertNumber  type="number" groupingUsed="true"/>
                                </h:outputText>
                            </p:column>

                            <p:column style="text-align: right; ">
                                <f:facet name="header">
                                    #{msg.tablaPrecioUnitario}
                                </f:facet>

                                <h:outputText value="#{lineaVenta.precioUnitario}" rendered="#{shopCartBean.vendedor}">
                                    <f:convertNumber currencySymbol="$" type="currency" groupingUsed="true"/>
                                </h:outputText>

                                <p:cellEditor rendered="#{not shopCartBean.vendedor}">
                                    <f:facet name="output">
                                        <h:outputText value="#{lineaVenta.precioUnitario}" >
                                            <f:convertNumber currencySymbol="$" type="currency" groupingUsed="true"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText id="precioVentaTabField" value="#{lineaVenta.precioUnitario}">
                                            <f:validateDoubleRange minimum="0.01"
                                                                   maximum="9999999999999999999.99" />
                                        </p:inputText>
                                    </f:facet>
                                </p:cellEditor>

                            </p:column>

                            <p:column style="text-align: right; ">
                                <f:facet name="header">
                                    #{msg.tablaSubTotal}
                                </f:facet>
                                <h:outputText value="#{lineaVenta.subTotal}" >
                                    <f:convertNumber currencySymbol="$" type="currency"  groupingUsed="true"/>
                                </h:outputText>
                            </p:column>

                            <p:column  exportable="false" >
                                <f:facet name="header">
                                    #{msg.borrar}
                                </f:facet>
                                <p:commandButton id="borrarItemButton"
                                                 icon="fa fa-fw fa-trash"
                                                 process="@this"
                                                 action="#{shopCartBean.removeFromCart(lineaVenta.item)}"
                                                 update="productosTable"
                                                 global="false"
                                                 >

                                </p:commandButton>
                            </p:column>

                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column colspan="7" footerText="#{msg.total}:"
                                              style="text-align:right; font-size: larger"  />

                                    <p:column  >
                                        <f:facet name="footer">
                                            <h:outputText value="#{shopCartBean.venta.total}" style="font-size: larger;font-weight: bold" >
                                                <f:convertNumber currencySymbol="$" type="currency"  groupingUsed="true"/>
                                            </h:outputText>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>
                    </div>
                </div>
                <div class="SeparatorFull"/>

                <p:panelGrid layout="grid"  styleClass="ui-panelgrid-blank" columns="2"
                             style="border:0px !important; background:none;"
                             >
                    <p:commandButton id="cancelarButton"
                                     icon="fa fa-fw fa-ban"
                                     value="#{msg.cancelar}"
                                     action="#{shopCartBean.endConversation()}"
                                     immediate="true"
                                     styleClass="RedButton">

                    </p:commandButton>

                    <p:commandButton id="siguienteButton"
                                     icon="fa fa-fw fa-arrow-right"
                                     value="#{msg.siguiente}"
                                     action="cliente.xhtml?faces-redirect=true"
                                     immediate="true">
                    </p:commandButton>
                </p:panelGrid>

                <h:form id="busquedaProductosForm" >
                    <p:dialog id="busquedaProductosDialog" header="#{msg.busquedaProductos}" widgetVar="dlgBusProd"
                              modal="true" dynamic="true" >
                        <gtsoftware:busquedaProductos model="#{shopCartBean}"
                                                      listaPrecios="#{shopCartBean.lista}"
                                                      soloConStock="true"
                                                      />
                        <div class="SeparatorFull" />

                        <p:commandButton value="#{msg.ok}" icon="fa fa-fw fa-check"
                                         oncomplete="PF('dlgBusProd').hide()"
                                         update=":formContenido"
                                         immediate="true"
                                         process="@this"
                                         actionListener="#{shopCartBean.addToCart()}"/>

                        <p:commandButton value="#{msg.cancelar}"
                                         immediate="true" icon="fa fa-fw fa-ban" onclick="PF('dlgBusProd').hide();"
                                         styleClass="RedButton"/>

                    </p:dialog>
                </h:form>
            </h:form>

        </div>
    </div>

</ui:composition>